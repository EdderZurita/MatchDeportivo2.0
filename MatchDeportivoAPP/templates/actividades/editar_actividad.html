{% extends 'base_usuario.html' %}
{% load static %}

{% block title %}Editar Actividad | {{ actividad.titulo }}{% endblock %}

{% block extra_css %}
<!-- ğŸš¨ INCLUIR GOOGLE MAPS API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDn0WsJFM5jcMk8QzXQrFGRGhTOpyKPdw8&libraries=places"></script>

<style>
Â  .form-label { font-weight: 600; }
Â  .btn-danger { transition: all 0.2s; }
Â  .btn-danger:hover { transform: scale(1.05); }
</style>
{% endblock %}

{% block usuario_content %}
<div class="container mt-5">
Â  <div class="card shadow p-4">
Â  Â  <h2 class="text-center mb-4">âš™ï¸ Editar Actividad</h2>
Â  Â  <p class="text-center text-muted">Modifica los detalles de la actividad "{{ actividad.titulo }}"</p>

Â  Â  <!-- InformaciÃ³n dinÃ¡mica de la actividad -->
Â  Â  <div class="alert alert-info">
Â  Â  Â  <strong>Actividad actual:</strong> {{ actividad.titulo }}<br>
Â  Â  Â  <strong>Deporte:</strong> {{ actividad.deporte|capfirst }}<br>
Â  Â  Â  <strong>Organizador:</strong> {{ actividad.organizador.username }}<br>
Â  Â  Â  <strong>Cupos disponibles:</strong> {{ actividad.cupos }} â€” <strong>Participantes:</strong> {{ actividad.participantes.count }}
Â  Â  </div>

Â  Â  <!-- Formulario de ediciÃ³n -->
    <!-- El action del formulario apunta a la misma URL (editar_actividad/pk) -->
Â  Â  <form method="POST">
Â  {% csrf_token %}

<div class="alert alert-info d-flex justify-content-between align-items-center">
Â  Â  Â  <div>
Â  Â  Â  Â  <strong>Actividad actual:</strong> {{ actividad.titulo }}<br>
Â  Â  Â  Â  <strong>Participantes inscritos:</strong> {{ actividad.participantes.count }}
Â  Â  Â  </div>
        <!-- ğŸš¨ NUEVO BOTÃ“N PARA GESTIONAR ğŸš¨ -->
        <a href="{% url 'gestionar_participantes' pk=actividad.pk %}" class="btn btn-info btn-sm">
            ğŸ‘¥ Administrar Participantes
        </a>
Â  Â  </div>
  <!-- Campo TÃ­tulo -->
  <div class="mb-3">
    <label for="titulo" class="form-label fw-semibold">TÃ­tulo</label>
    <input type="text" id="titulo" name="titulo" class="form-control" value="{{ actividad.titulo }}">
  </div>
  
Â  <div class="row">
Â  Â  <div class="col-md-4 mb-3">
Â  Â  <label for="deporte" class="form-label fw-semibold">Deporte</label>
Â  Â  <select id="deporte" name="deporte" class="form-select">
Â  Â  Â  Â  Â  {% comment %} Ahora iteramos sobre la lista 'deportes' del contexto {% endcomment %}
Â  Â  Â  Â  Â  {% for d in deportes %} 
Â  Â  Â  Â  Â  Â  <option value="{{ d }}" {% if d == actividad.deporte %}selected{% endif %}>{{ d|capfirst }}</option>
Â  Â  Â  Â  Â  {% endfor %}
Â  Â  </select>
</div>

Â  Â  <!-- ğŸš¨ Campo de UbicaciÃ³n con Autocomplete -->
Â  Â  <div class="col-md-4 mb-3">
Â  Â  Â  <label for="lugar" class="form-label fw-semibold">Lugar</label>
Â  Â  Â  <input type="text" id="autocomplete_actividad" name="lugar" class="form-control" value="{{ actividad.lugar }}">
Â  Â  </div>
    
    <!-- ğŸš¨ Campos ocultos para Latitud/Longitud (valores actuales) -->
Â  Â  <input type="hidden" id="latitud_actividad" name="latitud_actividad" value="{{ actividad.latitud|default_if_none:'' }}">
Â  Â  <input type="hidden" id="longitud_actividad" name="longitud_actividad" value="{{ actividad.longitud|default_if_none:'' }}">

Â  Â  <div class="col-md-2 mb-3">
Â  Â  Â  <label for="fecha" class="form-label fw-semibold">Fecha</label>
Â  Â  Â  <!-- Formatea la fecha a YYYY-MM-DD para el input type="date" -->
Â  Â  Â  <input type="date" id="fecha" name="fecha" class="form-control" value="{{ actividad.fecha|date:'Y-m-d' }}">
Â  Â  </div>

Â  Â  <!-- Hora de Inicio -->
Â  Â  <div class="col-md-2 mb-3">
Â  Â  Â  <label for="hora_inicio" class="form-label fw-semibold">Hora Inicio</label>
Â  Â  Â  <input type="time" id="hora_inicio" name="hora_inicio" class="form-control" value="{{ actividad.hora_inicio|time:'H:i' }}">
Â  Â  </div>
Â  </div>
  
  <div class="row">
      <div class="col-md-4 mb-3">
          <label for="hora_fin" class="form-label fw-semibold">Hora Fin (Opcional)</label>
          <input type="time" id="hora_fin" name="hora_fin" class="form-control" value="{{ actividad.hora_fin|time:'H:i' }}">
      </div>
      
Â  Â  Â  Â  <div class="col-md-4 mb-3">
Â  Â  Â  Â  Â  <label for="cupos" class="form-label fw-semibold">Cupos disponibles</label>
Â  Â  Â  Â  Â  <!-- MÃ­nimo de cupos es la cantidad de participantes actuales -->
Â  Â  Â  Â  Â  <input type="number" id="cupos" name="cupos" class="form-control" min="{{ actividad.participantes.count }}" max="50" value="{{ actividad.cupos }}">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="col-md-4 mb-3">
Â  Â  Â  Â  Â  <label for="nivel" class="form-label fw-semibold">Nivel</label>
Â  Â  Â  Â  Â  <select id="nivel" name="nivel" class="form-select">
Â  Â  Â  Â  Â  Â  <option value="Principiante" {% if actividad.nivel == 'Principiante' %}selected{% endif %}>Principiante</option>
Â  Â  Â  Â  Â  Â  <option value="Intermedio" {% if actividad.nivel == 'Intermedio' %}selected{% endif %}>Intermedio</option>
Â  Â  Â  Â  Â  Â  <option value="Avanzado" {% if actividad.nivel == 'Avanzado' %}selected{% endif %}>Avanzado</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  <label for="descripcion" class="form-label fw-semibold">DescripciÃ³n</label>
Â  Â  Â  Â  <textarea id="descripcion" name="descripcion" class="form-control" rows="3">{{ actividad.descripcion }}</textarea>
Â  Â  Â  </div>

Â  Â  Â  <!-- Botones -->
Â  Â  Â  <div class="d-flex justify-content-between mt-4">
Â  Â  Â  Â  <a href="{% url 'mis_actividades' %}" class="btn btn-outline-secondary">â¬… Volver</a>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary me-2">ğŸ’¾ Guardar cambios</button>
Â  Â  Â  Â  Â  <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">âŒ Cancelar actividad</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </form>
Â  </div>
</div>

<!-- Modal de confirmaciÃ³n de cancelaciÃ³n -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
Â  <div class="modal-dialog modal-dialog-centered">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header bg-danger text-white">
Â  Â  Â  Â  <h5 class="modal-title" id="cancelModalLabel">Confirmar cancelaciÃ³n</h5>
Â  Â  Â  Â  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-body text-center">
Â  Â  Â  Â  <p>Â¿EstÃ¡s seguro de que deseas cancelar esta actividad?</p>
Â  Â  Â  Â  <p class="text-muted">Esta acciÃ³n no se puede deshacer y notificarÃ¡ a todos los participantes inscritos.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-footer justify-content-center">
Â  Â  Â  Â  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
Â  Â  Â  Â  <!-- ğŸš¨ BotÃ³n que inicia la cancelaciÃ³n, apuntando a la URL -->
Â  Â  Â  Â  <a href="{% url 'cancelar_actividad' pk=actividad.pk %}" class="btn btn-danger">SÃ­, cancelar</a> 
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<!-- JavaScript para el Autocompletado de Google Maps -->
<script>
function initAutocompleteActividad() {
    const inputActividad = document.getElementById("autocomplete_actividad");

    const autocompleteActividad = new google.maps.places.Autocomplete(inputActividad, {
        types: ["geocode", "establishment"]
    });

    autocompleteActividad.addListener("place_changed", () => {
        const place = autocompleteActividad.getPlace();

        if (place.geometry) {
            // Guardar latitud y longitud en los campos ocultos
            document.getElementById("latitud_actividad").value = place.geometry.location.lat();
            document.getElementById("longitud_actividad").value = place.geometry.location.lng();
        } else {
            // Si el usuario borra el texto, tambiÃ©n limpiamos las coordenadas
            document.getElementById("latitud_actividad").value = '';
            document.getElementById("longitud_actividad").value = '';
        }
    });
}

// Llama a la funciÃ³n de autocompletado cuando la API de Google estÃ© lista
google.maps.event.addDomListener(window, 'load', initAutocompleteActividad);
</script>
{% endblock usuario_content %}