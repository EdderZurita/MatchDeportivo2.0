{% extends 'base_usuario.html' %}
{% load static %}

{% block title %}Mi Perfil | SportConnect{% endblock %}

{% block extra_css %}
<link href="{% static 'css/perfil.css' %}" rel="stylesheet">
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDn0WsJFM5jcMk8QzXQrFGRGhTOpyKPdw8&libraries=places&callback=initAutocomplete"
  async defer></script>
{% endblock %}

{% block usuario_content %}
<!-- Encabezado -->
<section class="profile-header">
  <div class="container text-center">
    <h2 class="fw-bold mb-1">Mi Perfil Deportivo</h2>
    <p>Gestiona tu información personal y tus intereses deportivos</p>
  </div>
</section>

<!-- Imagen -->
<div class="container text-center">
  {% if perfil.icono_perfil %}
  <img src="{% static perfil.icono_perfil %}" alt="Icono" class="profile-picture">
  {% else %}
  <img src="{% static 'img/default_profile.png' %}" alt="Foto de perfil" class="profile-picture">
  {% endif %}

  <p class="profile-name">{{ user.first_name }} {{ user.last_name }}</p>
  <p class="text-muted">{{ perfil.nickname|default:user.username }}</p>

  <!-- Rating y Valoraciones -->
  <div class="card mt-3 mx-auto" style="max-width: 500px;">
    <div class="card-body text-center">
      <h6 class="mb-3">
        <i class="bi bi-star-fill text-warning me-2"></i>
        Valoraciones Recibidas
      </h6>

      {% if perfil.rating_promedio %}
      <div class="mb-2">
        <span class="h4 text-warning">
          {% for i in "12345" %}
          {% if forloop.counter <= perfil.rating_promedio|floatformat:0 %} <i class="bi bi-star-fill"></i>
            {% else %}
            <i class="bi bi-star"></i>
            {% endif %}
            {% endfor %}
        </span>
        <p class="mb-0">
          <strong>{{ perfil.rating_promedio }}</strong> / 5.0
          <small class="text-muted">({{ perfil.total_valoraciones }} valoracion{{
            perfil.total_valoraciones|pluralize:"es" }})</small>
        </p>
      </div>
      {% else %}
      <p class="text-muted mb-0">
        <i class="bi bi-info-circle me-1"></i>
        Aún no has recibido valoraciones
      </p>
      {% endif %}

      <!-- Últimas 3 valoraciones -->
      {% if user.valoraciones_recibidas.all %}
      <hr>
      <h6 class="text-start mb-3">Últimas Valoraciones:</h6>
      {% for valoracion in user.valoraciones_recibidas.all|slice:":3" %}
      <div class="text-start mb-3 p-2 bg-light rounded">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>{{ valoracion.evaluador.username }}</strong>
            <span class="text-warning ms-2">
              {% for i in "12345" %}
              {% if forloop.counter <= valoracion.puntuacion %} ★ {% else %} ☆ {% endif %} {% endfor %} </span>
          </div>
          <small class="text-muted">{{ valoracion.fecha_creacion|date:"d/m/Y" }}</small>
        </div>
        {% if valoracion.comentario %}
        <p class="mb-0 mt-2 small text-muted">"{{ valoracion.comentario }}"</p>
        {% endif %}
        <small class="text-muted">En: {{ valoracion.actividad.titulo }}</small>
      </div>
      {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

<!-- Formulario -->
<div class="container form-section">
  <form method="post">
    {% csrf_token %}

    <!-- Selector de iconos -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Icono de perfil</label>

      <div class="icon-grid" id="icon-selector">
        {% for nombre, ruta in iconos %}
        <div class="icon-option {% if perfil.icono_perfil == ruta %}selected{% endif %}">
          <img src="{% static ruta %}" class="icon-img" data-icon="{{ ruta }}">
        </div>
        {% endfor %}
      </div>

      <input type="hidden" name="icono_perfil" id="icono_perfil" value="{{ perfil.icono_perfil }}">
    </div>

    <!-- Nombre -->
    <div class="mb-3">
      <label for="nombre" class="form-label fw-semibold">Nombre completo</label>
      <input type="text" id="nombre" name="nombre" value="{{ user.first_name }} {{ user.last_name }}"
        class="form-control">
    </div>

    <div class="mb-3">
      <label for="nickname" class="form-label fw-semibold">Nickname</label>
      <input type="text" id="nickname" name="nickname" value="{{ perfil.nickname }}" class="form-control">
    </div>

    <!-- Disciplinas -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Disciplinas deportivas</label>
      <select id="disciplinas" name="disciplinas" class="form-select">
        <option value="">Selecciona un deporte</option>
        <option value="futbol">Fútbol</option>
        <option value="basketball">Basketball</option>
        <option value="skate">Skate</option>
        <option value="voleibol">Vóleibol</option>
        <option value="running">Running</option>
        <option value="tenis">Tenis</option>
      </select>
    </div>

    <!-- Ubicación -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Ubicación</label>
      <input type="text" id="autocomplete" name="ubicacion" class="form-control"
        placeholder="Ej: Estadio Nacional, Santiago" value="{{ perfil.ubicacion }}">
    </div>

    <input type="hidden" id="latitud" name="latitud" value="{{ perfil.latitud }}">
    <input type="hidden" id="longitud" name="longitud" value="{{ perfil.longitud }}">

    <!-- Nivel -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Nivel</label>
      <select id="nivel" name="nivel" class="form-select">
        <option {% if perfil.nivel=="Principiante" %}selected{% endif %}>Principiante</option>
        <option {% if perfil.nivel=="Intermedio" %}selected{% endif %}>Intermedio</option>
        <option {% if perfil.nivel=="Avanzado" %}selected{% endif %}>Avanzado</option>
      </select>
    </div>

    <!-- Horarios -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Disponibilidad horaria</label>
      <input type="text" id="horarios" name="horarios" class="form-control" value="{{ perfil.horarios }}">
    </div>

    <!-- Radio -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Radio de búsqueda (km)</label>
      <input type="number" id="radio" name="radio" class="form-control" min="1" max="50" value="{{ perfil.radio }}">
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-primary">Guardar cambios</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/perfil.js' %}"></script>
{% endblock %}